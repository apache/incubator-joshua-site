<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Joshua Documentation | Grammar Packing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="/bootstrap/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
      #download {
          background-color: green;
          font-size: 14pt;
          font-weight: bold;
          text-align: center;
          color: white;
          border-radius: 5px;
          padding: 4px;
      }

      #download a:link {
          color: white;
      }

      #download a:hover {
          color: lightgrey;
      }

      #download a:visited {
          color: white;
      }

      a.pdf {
          font-variant: small-caps;
          /* font-weight: bold; */
          font-size: 10pt;
          color: white;
          background: brown;
          padding: 2px;
      }

      a.bibtex {
          font-variant: small-caps;
          /* font-weight: bold; */
          font-size: 10pt;
          color: white;
          background: orange;
          padding: 2px;
      }

      img.sponsor {
        height: 120px;
        margin: 5px;
      }
    </style>
    <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="bootstrap/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="bootstrap/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="bootstrap/ico/apple-touch-icon-114-precomposed.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="bootstrap/ico/apple-touch-icon-72-precomposed.png">
                    <link rel="apple-touch-icon-precomposed" href="bootstrap/ico/apple-touch-icon-57-precomposed.png">
                                   <link rel="shortcut icon" href="bootstrap/ico/favicon.png">
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="/">Joshua</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li><a href="index.html">Documentation</a></li>
              <li><a href="pipeline.html">Pipeline</a></li>
              <li><a href="tutorial.html">Tutorial</a></li>
              <li><a href="decoder.html">Decoder</a></li>
              <li><a href="thrax.html">Thrax</a></li>
              <li><a href="file-formats.html">File formats</a></li>
              <!-- <li><a href="advanced.html">Advanced</a></li> -->
              <li><a href="faq.html">FAQ</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">

      <div class="row">
        <div class="span2">
          <img src="/images/joshua-logo-small.png" 
               alt="Joshua logo (picture of a Joshua tree)" />
        </div>
        <div class="span10">
          <h1>Joshua Documentation</h1>
          <h2>Grammar Packing</h2>
          <span id="download">
            <a href="http://cs.jhu.edu/~post/files/joshua-v5.0.tgz">Download</a>
          </span>
          &nbsp; (version 5.0, released 16 August 2013)
        </div>
      </div>
      
      <hr />

      <div class="row">
        <div class="span8">

          <p>Grammar packing refers to the process of taking a textual grammar output by <a href="thrax.html">Thrax</a> and
efficiently encoding it for use by Joshua.  Packing the grammar results in significantly faster load
times for very large grammars.</p>

<p>Soon, the <a href="pipeline.html">Joshua pipeline script</a> will add support for grammar packing
automatically, and we will provide a script that automates these steps for you.</p>

<ol>
  <li>
    <p>Make sure the grammar is labeled.  A labeled grammar is one that has feature names attached to
each of the feature values in each row of the grammar file.  Here is a line from an unlabeled
grammar:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> [X] ||| [X,1] অন্যান্য [X,2] ||| [X,1] other [X,2] ||| 0 0 1 0 0 1.02184
</code></pre>
    </div>

    <p>and here is one from an labeled grammar (note that the labels are not very useful):</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> [X] ||| [X,1] অন্যান্য [X,2] ||| [X,1] other [X,2] ||| f1=0 f2=0 f3=1 f4=0 f5=0 f6=1.02184
</code></pre>
    </div>

    <p>If your grammar is not labeled, you can use the script <code class="highlighter-rouge">$JOSHUA/scripts/label_grammar.py</code>:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> zcat grammar.gz | $JOSHUA/scripts/label_grammar.py &gt; grammar-labeled.gz
</code></pre>
    </div>

    <p>As a side-effect of this step is to produce a file ‘dense_map’ in the current directory,
containing the mapping between feature names and feature columns.  This file is needed in later
steps.</p>
  </li>
  <li>
    <p>The packer needs a sorted grammar.  It is sufficient to sort by the first word:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> zcat grammar-labeled.gz | sort -k3,3 | gzip &gt; grammar-sorted.gz
</code></pre>
    </div>

    <p>(The reason we need a sorted grammar is because the packer stores the grammar in a trie.  The
pieces can’t be more than 2 GB due to Java limitations, so we need to ensure that rules are
grouped by the first arc in the trie to avoid redundancy across tries and to simplify the
lookup).</p>
  </li>
  <li>
    <p>In order to pack the grammar, we need two pieces of information: (1) a packer configuration file,
and (2) a dense map file.</p>

    <ol>
      <li>
        <p>Write a packer config file.  This file specifies items such as the chunk size (for the packed
pieces) and the quantization classes and types for each feature name.  Examples can be found
at</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>  $JOSHUA/test/packed/packer.config
  $JOSHUA/test/bn-en/packed/packer.quantized
  $JOSHUA/test/bn-en/packed/packer.uncompressed
</code></pre>
        </div>

        <p>The quantizer lines in the packer config file have the following format:</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>  quantizer TYPE FEATURES
</code></pre>
        </div>

        <p>where <code class="highlighter-rouge">TYPE</code> is one of <code class="highlighter-rouge">boolean</code>, <code class="highlighter-rouge">float</code>, <code class="highlighter-rouge">byte</code>, or <code class="highlighter-rouge">8bit</code>, and <code class="highlighter-rouge">FEATURES</code> is a
 space-delimited list of feature names that have that quantization type.</p>
      </li>
      <li>
        <p>Write a dense_map file.  If you labeled an unlabeled grammar, this was produced for you as a
side product of the <code class="highlighter-rouge">label_grammar.py</code> script you called in Step 1.  Otherwise, you need to
create a file that lists the mapping between feature names and (0-indexed) columns in the
grammar, one per line, in the following format:</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>  feature-index feature-name
</code></pre>
        </div>
      </li>
    </ol>
  </li>
  <li>
    <p>To pack the grammar, type the following command:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> java -cp $JOSHUA/bin joshua.tools.GrammarPacker -c PACKER_CONFIG_FILE -p OUTPUT_DIR -g GRAMMAR_FILE
</code></pre>
    </div>

    <p>This will read in your packer configuration file and your grammar, and produced a packed grammar
 in the output directory.</p>
  </li>
  <li>
    <p>To use the packed grammar, just point to the packed directory in your Joshua configuration file.</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> tm-file = packed-grammar/
 tm-format = packed
</code></pre>
    </div>
  </li>
</ol>


        </div>
      </div>
    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="bootstrap/js/jquery.js"></script>
    <script src="bootstrap/js/bootstrap-transition.js"></script>
    <script src="bootstrap/js/bootstrap-alert.js"></script>
    <script src="bootstrap/js/bootstrap-modal.js"></script>
    <script src="bootstrap/js/bootstrap-dropdown.js"></script>
    <script src="bootstrap/js/bootstrap-scrollspy.js"></script>
    <script src="bootstrap/js/bootstrap-tab.js"></script>
    <script src="bootstrap/js/bootstrap-tooltip.js"></script>
    <script src="bootstrap/js/bootstrap-popover.js"></script>
    <script src="bootstrap/js/bootstrap-button.js"></script>
    <script src="bootstrap/js/bootstrap-collapse.js"></script>
    <script src="bootstrap/js/bootstrap-carousel.js"></script>
    <script src="bootstrap/js/bootstrap-typeahead.js"></script>

    <!-- Start of StatCounter Code for Default Guide -->
    <script type="text/javascript">
      var sc_project=8264132; 
      var sc_invisible=1; 
      var sc_security="4b97fe2d"; 
    </script>
    <script type="text/javascript" src="http://www.statcounter.com/counter/counter.js"></script>
    <noscript>
      <div class="statcounter">
        <a title="hit counter joomla" 
           href="http://statcounter.com/joomla/"
           target="_blank">
          <img class="statcounter"
               src="http://c.statcounter.com/8264132/0/4b97fe2d/1/"
               alt="hit counter joomla" />
        </a>
      </div>
    </noscript>
    <!-- End of StatCounter Code for Default Guide -->

  </body>
</html>
