<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" type="text/css" media="screen,print" href="../joshua4.css" />
    <title>Joshua | Building Translation Models</title>
  </head>

  <body>

    <div id="navbar">
      <a href="http://joshua-decoder.org/">
        <img src="../images/joshua-logo-small.png" width="130px" 
             alt="Joshua logo (picture of a Joshua tree)" />
      </a>

      <p class="infobox">
        <b>Stable version</b><br />
        4.1<br/><br/>
        <b>Release date</b><br />
        2013 January
      </p>

<!--       <div class="infobox"> -->
<!--         <b>AUTO LINKS</b><br/> -->
<!--         <ul> -->
<!--            -->
<!--           <li> Advanced features</li> -->
<!--            -->
<!--           <li> Advanced features</li> -->
<!--            -->
<!--           <li> Advanced features</li> -->
<!--            -->
<!--           <li> Building a language pack</li> -->
<!--            -->
<!--           <li> Building a language pack</li> -->
<!--            -->
<!--           <li> Bundling a configuration</li> -->
<!--            -->
<!--           <li> Contributors</li> -->
<!--            -->
<!--           <li> Decoder configuration parameters</li> -->
<!--            -->
<!--           <li> Decoder configuration parameters</li> -->
<!--            -->
<!--           <li> Decoder configuration parameters</li> -->
<!--            -->
<!--           <li> Decoder configuration parameters</li> -->
<!--            -->
<!--           <li> Frequently Asked Questions</li> -->
<!--            -->
<!--           <li> Common problems</li> -->
<!--            -->
<!--           <li> Frequently Asked Questions</li> -->
<!--            -->
<!--           <li> Common problems</li> -->
<!--            -->
<!--           <li> Features</li> -->
<!--            -->
<!--           <li> Features</li> -->
<!--            -->
<!--           <li> Features</li> -->
<!--            -->
<!--           <li> Features</li> -->
<!--            -->
<!--           <li> Joshua file formats</li> -->
<!--            -->
<!--           <li> Joshua file formats</li> -->
<!--            -->
<!--           <li> Joshua file formats</li> -->
<!--            -->
<!--           <li> Joshua file formats</li> -->
<!--            -->
<!--           <li> </li> -->
<!--            -->
<!--           <li> </li> -->
<!--            -->
<!--           <li> </li> -->
<!--            -->
<!--           <li> Fisher and CALLHOME Spanish English Speech Translation Corpus</li> -->
<!--            -->
<!--           <li> Indian Languages Parallel Corpora</li> -->
<!--            -->
<!--           <li> Joshua 4.0 User Documentation</li> -->
<!--            -->
<!--           <li> Language packs</li> -->
<!--            -->
<!--           <li> Paraphrase Packs</li> -->
<!--            -->
<!--           <li> Joshua releases</li> -->
<!--            -->
<!--           <li> Support</li> -->
<!--            -->
<!--           <li> Getting Started</li> -->
<!--            -->
<!--           <li> Welcome to Joshua</li> -->
<!--            -->
<!--           <li> Joshua documentation</li> -->
<!--            -->
<!--           <li> Joshua documentation</li> -->
<!--            -->
<!--           <li> Installation</li> -->
<!--            -->
<!--           <li> Installation</li> -->
<!--            -->
<!--           <li> Alignment with Jacana</li> -->
<!--            -->
<!--           <li> Alignment with Jacana</li> -->
<!--            -->
<!--           <li> Alignment with Jacana</li> -->
<!--            -->
<!--           <li> Building large LMs with SRILM</li> -->
<!--            -->
<!--           <li> Building large LMs with SRILM</li> -->
<!--            -->
<!--           <li> Building large LMs with SRILM</li> -->
<!--            -->
<!--           <li> Building large LMs with SRILM</li> -->
<!--            -->
<!--           <li> Lattice decoding</li> -->
<!--            -->
<!--           <li> Grammar Packing</li> -->
<!--            -->
<!--           <li> Grammar Packing</li> -->
<!--            -->
<!--           <li> Grammar Packing</li> -->
<!--            -->
<!--           <li> Grammar Packing</li> -->
<!--            -->
<!--           <li> The Joshua Pipeline</li> -->
<!--            -->
<!--           <li> The Joshua Pipeline</li> -->
<!--            -->
<!--           <li> The Joshua Pipeline</li> -->
<!--            -->
<!--           <li> The Joshua Pipeline</li> -->
<!--            -->
<!--           <li> Quick Start</li> -->
<!--            -->
<!--           <li> Quick Start</li> -->
<!--            -->
<!--           <li> Releases</li> -->
<!--            -->
<!--           <li> Server mode</li> -->
<!--            -->
<!--           <li> Server mode</li> -->
<!--            -->
<!--           <li> Server mode</li> -->
<!--            -->
<!--           <li> Installing and running the Joshua Decoder</li> -->
<!--            -->
<!--           <li> Grammar extraction with Thrax</li> -->
<!--            -->
<!--           <li> Grammar extraction with Thrax</li> -->
<!--            -->
<!--           <li> Grammar extraction with Thrax</li> -->
<!--            -->
<!--           <li> Grammar extraction with Thrax</li> -->
<!--            -->
<!--           <li> Building Translation Models</li> -->
<!--            -->
<!--           <li> Building Translation Models</li> -->
<!--            -->
<!--           <li> Building Translation Models</li> -->
<!--            -->
<!--           <li> Building Translation Models</li> -->
<!--            -->
<!--           <li> Pipeline tutorial</li> -->
<!--            -->
<!--           <li> Pipeline tutorial</li> -->
<!--            -->
<!--           <li> Pipeline tutorial</li> -->
<!--            -->
<!--           <li> What's New</li> -->
<!--            -->
<!--           <li> What's New</li> -->
<!--            -->
<!--           <li> Z-MERT</li> -->
<!--            -->
<!--           <li> Z-MERT</li> -->
<!--            -->
<!--           <li> Z-MERT</li> -->
<!--            -->
<!--           <li> Z-MERT</li> -->
<!--            -->
<!--           <li> </li> -->
<!--            -->
<!--           <li> </li> -->
<!--            -->
<!--           <li> </li> -->
<!--            -->
<!--         </ul> -->
<!--       </div>   -->

      <div class="infobox">

        <b>Links</b><br />
        <ul>
          <li> <a href="../index.html">Main</a> </li>
          <li> <a href="pipeline.html">Pipeline</a> </li>
          <li> <a href="step-by-step-instructions.html">Manual walkthrough</a> </li>
          <li> <a href="decoder.html">Decoder</a> </li>
          <li> <a href="server.html">Decoder Server</a> </li>
          <li> <a href="file-formats.html">File formats</a> </li>
          <li> <a href="thrax.html">Grammar Extraction</a> </li>
          <li> <a href="../releases.html">Releases</a> </li>
        </ul>
      </div>

      <div class="infobox">
        <b>Advanced</b><br />
        <ul>
<!--          <li> <a href="packing.html">Grammar packing</a> </li> -->
          <li> <a href="large-lms.html">Building large LMs</a> </li>
          <li> <a href="zmert.html">Running Z-MERT</a> </li>
          <li> <a href="lattice.html">Lattices</a> </li>
          <li> <a href="server.html">TCP/IP server</a> </li>
          <li> <a href="bundle.html">Bundled configuration</a> </li>
        </ul>
      </div>

      <div class="infobox">
        <b>Help</b><br />
        <ul>
          <li> <a href="faq.html">Answers</a> </li>
          <li> <a href="https://groups.google.com/d/forum/joshua_support">Archive</a> </li>
        </ul>
      </div>

      <div class="footer">
        Last updated on April 08, 2016
      </div>

    </div>

    <div id="main">
      <div id="title">
        <h1>Building Translation Models</h1>
      </div>

      <div id="content">
        
        <h1 id="build-a-translation-model">Build a translation model</h1>

<p>Extracting a grammar from a large amount of data is a multi-step process. The first requirement is parallel data. The Europarl, Call Home, and Fisher corpora all contain parallel translations of Spanish and English sentences.</p>

<p>We will copy (or symlink) the parallel source text files in a subdirectory called <code class="highlighter-rouge">input/</code>.</p>

<p>Then, we concatenate all the training files on each side. The pipeline script normally does tokenization and normalization, but in this instance we have a custom tokenizer we need to apply to the source side, so we have to do it manually and then skip that step using the <code class="highlighter-rouge">pipeline.pl</code> option <code class="highlighter-rouge">--first-step alignment</code>.</p>

<ul>
  <li>
    <p>to tokenize the English data, do</p>

    <table>
      <tbody>
        <tr>
          <td>cat callhome.en europarl.en fisher.en &gt; all.en</td>
          <td>$JOSHUA/scripts/training/normalize-punctuation.pl en</td>
          <td>$JOSHUA/scripts/training/penn-treebank-tokenizer.perl</td>
          <td>$JOSHUA/scripts/lowercase.perl &gt; all.norm.tok.lc.en</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<p>The same can be done for the Spanish side of the input data:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cat callhome.es europarl.es fisher.es &gt; all.es | $JOSHUA/scripts/training/normalize-punctuation.pl es | $JOSHUA/scripts/training/penn-treebank-tokenizer.perl | $JOSHUA/scripts/lowercase.perl &gt; all.norm.tok.lc.es
</code></pre>
</div>

<p>By the way, an alternative tokenizer is a Twitter tokenizer found in the <a href="http://github.com/vandurme/jerboa">Jerboa</a> project.</p>

<p>The final step in the training data preparation is to remove all examples in which either of the language sides is a blank line.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>paste all.norm.tok.lc.es all.norm.tok.lc.en | grep -Pv "^\t|\t$" \
  | ./splittabs.pl all.norm.tok.lc.noblanks.es all.norm.tok.lc.noblanks.en
</code></pre>
</div>

<p>contents of <code class="highlighter-rouge">splittabls.pl</code> by Matt Post:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">#!/usr/bin/perl</span>

<span class="c1"># splits on tab, printing respective chunks to the list of files given</span>
<span class="c1"># as script arguments</span>

<span class="k">use</span> <span class="nv">FileHandle</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">@fh</span><span class="p">;</span>
<span class="vg">$|</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="c1"># don't buffer output</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">@ARGV</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">print</span> <span class="s">"Usage: splittabs.pl &lt; tabbed-file\n"</span><span class="p">;</span>
  <span class="nb">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">@fh</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">{</span> <span class="nv">get_filehandle</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">}</span> <span class="nv">@ARGV</span><span class="p">;</span>
<span class="nv">@ARGV</span> <span class="o">=</span> <span class="p">();</span>

<span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="o">&lt;&gt;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">chomp</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span>
  <span class="k">my</span> <span class="p">(</span><span class="nv">@fields</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/\t/</span><span class="p">,</span><span class="nv">$line</span><span class="p">,</span><span class="nb">scalar</span> <span class="nv">@fh</span><span class="p">);</span>

  <span class="nb">map</span> <span class="p">{</span> <span class="k">print</span> <span class="p">{</span><span class="nv">$fh</span><span class="p">[</span><span class="nv">$_</span><span class="p">]}</span> <span class="s">"$fields[$_]\n"</span> <span class="p">}</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="nv">$#fields</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">get_filehandle</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span> <span class="ow">eq</span> <span class="s">"-"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">*</span><span class="bp">STDOUT</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">local</span> <span class="o">*</span><span class="nv">FH</span><span class="p">;</span>
        <span class="nb">open</span> <span class="nv">FH</span><span class="p">,</span> <span class="s">"&gt;$file"</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">"can't open '$file' for writing"</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">*</span><span class="nv">FH</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now we can run the pipeline to extract the grammar. Run the following script:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># this creates a grammar</span>

<span class="c"># NEED:</span>
<span class="c"># pair</span>
<span class="c"># type</span>

<span class="nb">set</span> -u

<span class="nv">pair</span><span class="o">=</span>es-en
<span class="nb">type</span><span class="o">=</span>hiero

<span class="c">#. ~/.bashrc</span>

<span class="c">#basedir=$(pwd)</span>

<span class="nv">dir</span><span class="o">=</span>grammar-<span class="nv">$pair</span>-<span class="nv">$type</span>

<span class="o">[[</span> ! -d <span class="nv">$dir</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> mkdir -p <span class="nv">$dir</span>
<span class="nb">cd</span> <span class="nv">$dir</span>

<span class="nb">source</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$pair</span> | cut -d- -f 1<span class="k">)</span>
<span class="nv">target</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$pair</span> | cut -d- -f 2<span class="k">)</span>

<span class="nv">$JOSHUA</span>/scripts/training/pipeline.pl <span class="se">\</span>
  --source <span class="nv">$source</span> <span class="se">\</span>
  --target <span class="nv">$target</span> <span class="se">\</span>
  --corpus /home/hltcoe/lorland/expts/scale12/model1/input/all.norm.tok.lc.noblanks <span class="se">\</span>
  --type <span class="nv">$type</span> <span class="se">\</span>
  --joshua-mem 100g <span class="se">\</span>
  --no-prepare <span class="se">\</span>
  --first-step align <span class="se">\</span>
  --last-step thrax <span class="se">\</span>
  --hadoop <span class="nv">$HADOOP</span> <span class="se">\</span>
  --threads 8 <span class="se">\</span>
</code></pre>
</div>


      </div>
    </div>

  </body>
</html>





